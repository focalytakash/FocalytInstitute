<% include partials/header %>
<div class="content-header row d-xl-block d-lg-block d-md-none d-sm-none d-none">
  <div class="content-header-left col-md-9 col-12 mb-2">
    <div class="row breadcrumbs-top">
      <div class="col-12">
        <h3 class="content-header-title float-left mb-0">ðŸ’¬ Chat History</h3>
        <div class="breadcrumb-wrapper col-12">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="<%= process.env.MIPIE_BACKEND_URL %>/admin">Home</a></li>
            <li class="breadcrumb-item active">Chat History</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="content-body">
  <% include partials/flash %>
  <section class="list-view">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">All Chat Sessions</h4>
            <div class="card-tools">
              <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="searchMobile" class="form-control" placeholder="Search by Mobile...">
                <div class="input-group-append">
                  <button type="button" class="btn btn-primary" onclick="loadChatHistory()">
                    <i class="fa fa-search"></i>
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="clearSearch()">
                    <i class="fa fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="chatHistoryTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Mobile</th>
                    <th>Email</th>
                    <th>Candidate</th>
                    <th>User Messages</th>
                    <th>Last Message</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="chatHistoryBody">
                  <tr>
                    <td colspan="7" class="text-center">
                      <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <span id="paginationInfo" class="text-muted">Loading...</span>
              </div>
              <nav>
                <ul class="pagination mb-0" id="pagination">
                  <!-- Pagination will be generated by JavaScript -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Chat Session Detail Modal -->
<div class="modal fade" id="chatSessionModal" tabindex="-1" role="dialog" aria-labelledby="chatSessionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document" style="max-width: 650px;">
    <div class="modal-content" style="border: none; border-radius: 14px; overflow: hidden; box-shadow: 0 12px 48px rgba(0,0,0,0.15);">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 18px 24px; border: none;">
        <h5 class="modal-title" id="chatSessionModalLabel" style="font-weight: 600; font-size: 17px; letter-spacing: 0.2px;">
          <i class="fa fa-comments mr-2"></i>Chat Conversation
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white; opacity: 1; font-size: 24px; font-weight: 300; padding: 0; background: transparent; border: none;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="chatSessionModalBody" style="padding: 0; background: #EFEAE2; overflow: hidden;">
        <div class="text-center py-5" style="padding: 40px 20px;">
          <div class="spinner-border" style="color: #667eea; width: 3rem; height: 3rem; border-width: 3px;" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          <p class="mt-3 text-muted" style="font-size: 15px; font-weight: 400;">Loading conversation...</p>
        </div>
      </div>
      <div class="modal-footer" style="background: #F9FAFB; border-top: 1px solid #E5E7EB; padding: 14px 24px;">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" style="border-radius: 8px; padding: 8px 20px; font-size: 14px; font-weight: 500;">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<style>

.message-bubble {
  position: relative;
  word-wrap: break-word;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.message-bubble:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.12) !important;
}

.user-message {
  background: #DCF8C6 !important;
  border-radius: 7.5px 7.5px 0 7.5px !important;
}

.ai-message {
  background: #FFFFFF !important;
  border-radius: 7.5px 7.5px 7.5px 0 !important;
  border: 1px solid #E4E6EB !important;
}

/* Clean WhatsApp-style scrollbar */
.chat-container::-webkit-scrollbar {
  width: 6px;
}

.chat-container::-webkit-scrollbar-track {
  background: transparent;
}

.chat-container::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 3px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.3);
}
</style>

<script>
let currentPage = 1;
let currentLimit = 50;
let currentMobile = '';

// Load chat history on page load
document.addEventListener('DOMContentLoaded', function() {
  loadChatHistory();
  
  // Check if there's a session parameter in URL
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session');
  if (sessionId) {
    viewChatSession(sessionId);
  }
});

// Load chat history data
function loadChatHistory(page = 1) {
  currentPage = page;
  const mobile = document.getElementById('searchMobile').value.trim();
  currentMobile = mobile;
  
  const params = new URLSearchParams({
    page: currentPage,
    limit: currentLimit
  });
  
  if (mobile) {
    params.append('mobile', mobile);
  }
  
  fetch(`<%= process.env.MIPIE_BACKEND_URL %>/admin/chatHistory/data?${params.toString()}`)
    .then(response => response.json())
    .then(data => {
      if (data.status) {
        renderChatHistory(data.data, data.pagination);
      } else {
        showError(data.message || 'Failed to load chat history');
      }
    })
    .catch(error => {
      console.error('Error loading chat history:', error);
      showError('Failed to load chat history');
    });
}

// Render chat history table
function renderChatHistory(histories, pagination) {
  const tbody = document.getElementById('chatHistoryBody');
  
  if (!histories || histories.length === 0) {
    tbody.innerHTML = `
                  <tr>
                    <td colspan="7" class="text-center text-muted">
                      <i class="fa fa-inbox fa-3x mb-2"></i>
                      <p>No chat history found</p>
                    </td>
                  </tr>
    `;
    return;
  }
  
  tbody.innerHTML = histories.map((history, index) => {
    const rowNum = (pagination.page - 1) * pagination.limit + index + 1;
    const lastMessageDate = history.lastMessageAt 
      ? new Date(history.lastMessageAt).toLocaleString('en-IN')
      : 'N/A';
    
    // Get user messages count from backend
    const userMessagesCount = history.userMessagesCount || 0;
    
    const candidateLink = history.candidateId
      ? `<a href="<%= process.env.MIPIE_BACKEND_URL %>/admin/candidate/${history.candidateId._id}" target="_blank">${history.candidateId.name || 'N/A'}</a>`
      : 'N/A';
    
    return `
      <tr>
        <td>${rowNum}</td>
        <td>${history.mobile || 'N/A'}</td>
        <td>${history.email || 'N/A'}</td>
        <td>${candidateLink}</td>
        <td><span class="badge badge-primary">${userMessagesCount}</span></td>
        <td>${lastMessageDate}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="viewChatSession('${history.sessionId}')" title="View User Messages">
            <i class="fa fa-eye"></i> View
          </button>
        </td>
      </tr>
    `;
  }).join('');
  
  // Update pagination info
  document.getElementById('paginationInfo').textContent = 
    `Showing ${(pagination.page - 1) * pagination.limit + 1} to ${Math.min(pagination.page * pagination.limit, pagination.total)} of ${pagination.total} entries`;
  
  // Render pagination
  renderPagination(pagination);
}

// Render pagination
function renderPagination(pagination) {
  const paginationEl = document.getElementById('pagination');
  const pages = [];
  const totalPages = pagination.pages;
  const current = pagination.page;
  
  // Previous button
  pages.push(`
    <li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadChatHistory(${current - 1}); return false;">Previous</a>
    </li>
  `);
  
  // Page numbers
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= current - 2 && i <= current + 2)) {
      pages.push(`
        <li class="page-item ${i === current ? 'active' : ''}">
          <a class="page-link" href="#" onclick="loadChatHistory(${i}); return false;">${i}</a>
        </li>
      `);
    } else if (i === current - 3 || i === current + 3) {
      pages.push(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
    }
  }
  
  // Next button
  pages.push(`
    <li class="page-item ${current === totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadChatHistory(${current + 1}); return false;">Next</a>
    </li>
  `);
  
  paginationEl.innerHTML = pages.join('');
}

// View chat session details
function viewChatSession(sessionId) {
  const modal = $('#chatSessionModal');
  const modalBody = document.getElementById('chatSessionModalBody');
  
  modalBody.innerHTML = `
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
  `;
  
  modal.modal('show');
  
  fetch(`<%= process.env.MIPIE_BACKEND_URL %>/admin/chatHistory/session/${sessionId}?ajax=true`)
    .then(response => response.json())
    .then(data => {
      if (data.status && data.data) {
        renderChatSessionDetails(data.data);
      } else {
        modalBody.innerHTML = `
          <div class="alert alert-danger">
            <i class="fa fa-exclamation-triangle"></i> ${data.message || 'Failed to load chat session'}
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Error loading chat session:', error);
      modalBody.innerHTML = `
        <div class="alert alert-danger">
          <i class="fa fa-exclamation-triangle"></i> Failed to load chat session
        </div>
      `;
    });
}

// Render chat session details in modal
function renderChatSessionDetails(chatHistory) {
  const modalBody = document.getElementById('chatSessionModalBody');
  
  // Get all messages and sort by timestamp
  const allMessages = chatHistory.messages && chatHistory.messages.length > 0
    ? [...chatHistory.messages].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
    : [];
  
  const userMessagesCount = allMessages.filter(msg => msg.role === 'user').length;
  const aiMessagesCount = allMessages.filter(msg => msg.role === 'assistant').length;
  
  const messagesHtml = allMessages.length > 0
    ? allMessages.map((message, index) => {
        const isUser = message.role === 'user';
        const timestamp = new Date(message.timestamp).toLocaleString('en-IN', {
          hour: '2-digit',
          minute: '2-digit',
          day: 'numeric',
          month: 'short'
        });
        
        // Clean WhatsApp-style chat with proper spacing
        if (isUser) {
          // User message - Right aligned, Green bubble
          return `
            <div style="display: flex; justify-content: flex-end; margin-bottom: 8px; padding: 0 12px;">
              <div style="max-width: 75%; background: #DCF8C6; border-radius: 7.5px 7.5px 0 7.5px; padding: 8px 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); ">
                <div style="color: #000000; font-size: 14.2px; word-wrap: break-word; line-height: 1.4; margin: 0; textAlign: left;">
                  ${message.content || ''}
                </div>
                <div style="text-align: right; font-size: 11px; color: #667781; margin-top: 4px; padding-top: 2px;">
                  ${timestamp}
                </div>
              </div>
            </div>
          `;
        } else {
          // AI Assistant message - Left aligned, Blue/White bubble
          return `
            <div style="display: flex; justify-content: flex-start; margin-bottom: 8px; padding: 0 12px;">
              <div style="max-width: 75%; background: #FFFFFF; border-radius: 7.5px 7.5px 7.5px 0; padding: 8px 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border: 1px solid #E4E6EB;">
                <div style="color: #111B21; font-size: 14.2px; word-wrap: break-word; line-height: 1.4; margin: 0; textAlign: left;">
                  ${message.content || ''}
                </div>
                ${message.jobs && message.jobs.length > 0 ? `
                  <div style="margin-top: 8px; padding: 8px; background: #FEF3C7; border-radius: 6px; font-size: 12px; border-left: 3px solid #F59E0B;">
                    <strong style="color: #92400E; font-weight: 600;">ðŸ“‹ Jobs Found: ${message.jobs.length}</strong>
                  </div>
                ` : ''}
                <div style="text-align: left; font-size: 11px; color: #667781; margin-top: 4px; padding-top: 2px;">
                  ${timestamp}
                </div>
              </div>
            </div>
          `;
        }
      }).join('')
    : '<div style="text-align: center; padding: 40px 20px;"><div style="color: #667781; font-size: 15px;"><i class="fa fa-comments fa-3x mb-3" style="opacity: 0.3;"></i><p style="margin: 0;">No messages in this session</p></div></div>';
  
  modalBody.innerHTML = `
    <div class="chat-container" style="padding: 16px 8px; background: #EFEAE2; max-height: 650px; overflow-y: auto; min-height: 500px; position: relative;">
      ${messagesHtml}
      <div id="chatScrollAnchor"></div>
    </div>
  `;
  
  // Auto scroll to bottom after rendering
  setTimeout(() => {
    const chatContainer = modalBody.querySelector('.chat-container');
    if (chatContainer) {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
  }, 100);
}

// Clear search
function clearSearch() {
  document.getElementById('searchMobile').value = '';
  loadChatHistory(1);
}

// Show error message
function showError(message) {
  const tbody = document.getElementById('chatHistoryBody');
  tbody.innerHTML = `
    <tr>
      <td colspan="7" class="text-center text-danger">
        <i class="fa fa-exclamation-triangle fa-2x mb-2"></i>
        <p>${message}</p>
      </td>
    </tr>
  `;
}

// Handle Enter key in search input
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchMobile');
  if (searchInput) {
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadChatHistory(1);
      }
    });
  }
});
</script>

<% include partials/footer %>

